<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCB BProf Quality Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        /* All the existing styles remain the same */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .header {
            background-color: #1e40af;
            color: white;
            padding: 1rem 0;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .tab-content {
            display: none;
            padding: 1.5rem 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .qa-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .qa-type-first-draft {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .qa-type-revision {
            background-color: #e0e7ff;
            color: #4338ca;
        }
        
        .final-score-badge {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .final-score-note {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }
        
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .filter-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 10;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        
        .filter-dropdown:hover .filter-dropdown-content {
            display: block;
        }
        
        .date-filter-badge {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .date-filter-badge button {
            margin-left: 0.5rem;
            color: #0369a1;
            font-weight: bold;
        }
        
        .category-icon {
            display: inline-block;
            margin-right: 0.25rem;
        }
        
        .description-tooltip {
            position: relative;
            cursor: pointer;
        }
        
        .description-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .description-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .description-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #10b981;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .delete-btn {
            color: #ef4444;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            color: #b91c1c;
            transform: scale(1.1);
        }
        
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }
        
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: #f3f4f6;
        }
        
        .sortable::after {
            content: "↕";
            position: absolute;
            right: 8px;
            color: #9ca3af;
            font-size: 0.75rem;
        }
        
        .sortable.asc::after {
            content: "↑";
            color: #3b82f6;
        }
        
        .sortable.desc::after {
            content: "↓";
            color: #3b82f6;
        }
        
        .developer-score-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .developer-score-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .date-filter-panel {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            z-index: 50;
            width: 300px;
            display: none;
        }
        
        .date-filter-panel.show {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        
        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 30px;
            background-color: #3b82f6;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            text-align: center;
            font-size: 0.75rem;
            color: #4b5563;
            width: 30px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chart-value {
            position: absolute;
            top: -20px;
            width: 30px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .csv-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }
        
        .csv-upload-area:hover {
            border-color: #93c5fd;
            background-color: #eff6ff;
        }
        
        .csv-upload-area.drag-over {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        
        .csv-template-link {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .csv-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .csv-success {
            color: #10b981;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .csv-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .csv-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
        }
        
        /* Add new styles for auth */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Auth Container -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">HCB BProf Quality Tracker</h2>
        <div id="login-form">
            <div class="mb-4">
                <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                <input type="email" id="email" class="w-full p-2 border rounded-md" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                <input type="password" id="password" class="w-full p-2 border rounded-md" required>
            </div>
            <div class="flex justify-between items-center">
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">Login</button>
                <button id="signup-btn" class="text-blue-600 hover:text-blue-800">Create Account</button>
            </div>
            <p id="auth-error" class="text-red-600 mt-4" style="display: none;"></p>
        </div>
    </div>
    
    <!-- Main App Container (will be shown after authentication) -->
    <div id="app-container" style="display: none;">
        <header class="header">
            <div class="container flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">HCB BProf Quality Tracker</h1>
                    <p class="text-sm opacity-80">Track and evaluate localization quality for digital learning content</p>
                </div>
                <div class="flex items-center">
                    <span id="user-email" class="text-white mr-4"></span>
                    <button id="logout-btn" class="bg-blue-800 hover:bg-blue-900 text-white font-medium py-1 px-3 rounded-md transition duration-200 text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Rest of the app content remains the same -->
        <div class="container">
        <div class="bg-white rounded-lg shadow-sm mt-6">
        <div class="flex border-b">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="qa-review">QA Review</div>
            <div class="tab" data-tab="scoring">Scoring Reference</div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800">Projects Overview</h2>
                <div class="flex space-x-2">
                    <div class="relative">
                        <button id="date-filter-btn" class="bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            Date Filter
                        </button>
                        <div id="date-filter-panel" class="date-filter-panel">
                            <h4 class="font-medium text-gray-700 mb-3">Filter Dashboard by Date</h4>
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                                <select id="dashboard-month-filter" class="w-full border rounded-md px-2 py-1">
                                    <option value="">All Months</option>
                                    <option value="0">January</option>
                                    <option value="1">February</option>
                                    <option value="2">March</option>
                                    <option value="3">April</option>
                                    <option value="4">May</option>
                                    <option value="5">June</option>
                                    <option value="6">July</option>
                                    <option value="7">August</option>
                                    <option value="8">September</option>
                                    <option value="9">October</option>
                                    <option value="10">November</option>
                                    <option value="11">December</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                <select id="dashboard-year-filter" class="w-full border rounded-md px-2 py-1">
                                    <option value="">All Years</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="flex justify-between">
                                <button id="reset-dashboard-filter" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1 px-3 rounded-md transition duration-200 text-sm">
                                    Reset
                                </button>
                                <button id="apply-dashboard-filter" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded-md transition duration-200 text-sm">
                                    Apply Filter
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="add-project-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                        Add New Project
                    </button>
                </div>
            </div>
            
            <div id="dashboard-filter-info" class="mb-4 hidden">
                <div class="bg-blue-50 p-3 rounded-md flex justify-between items-center">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                        <span class="text-blue-700" id="dashboard-filter-text">Showing data for: </span>
                    </div>
                    <button id="clear-dashboard-filter" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                        Clear Filter
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="stat-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Projects</h3>
                    <p class="text-3xl font-bold text-blue-600" id="total-projects">0</p>
                </div>
                <div class="stat-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">For Review/QA</h3>
                    <p class="text-3xl font-bold text-blue-600" id="in-progress-projects">0</p>
                </div>
                <div class="stat-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Needs Revision</h3>
                    <p class="text-3xl font-bold text-red-600" id="needs-revision-projects">0</p>
                </div>
                <div class="stat-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Completed</h3>
                    <p class="text-3xl font-bold text-green-600" id="completed-projects">0</p>
                </div>
                <div class="stat-card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Average QA Score</h3>
                    <p class="text-3xl font-bold text-purple-600" id="average-qa-score">0.0</p>
                </div>
            </div>
            
            <!-- Developer Performance Section -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Developer Performance</h3>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-500 mr-2">Sort by:</span>
                        <select id="developer-sort" class="border rounded-md px-2 py-1 text-sm">
                            <option value="name">Name</option>
                            <option value="score" selected>Score</option>
                            <option value="projects">Projects</option>
                        </select>
                    </div>
                </div>
                
                <div id="developer-chart" class="mb-6">
                    <div class="chart-container" id="developer-score-chart">
                        <!-- Chart bars will be added here -->
                    </div>
                </div>
                
                <div id="developer-scores" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Developer score cards will be added here -->
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 space-y-3 md:space-y-0">
                    <h3 class="text-lg font-semibold text-gray-700">Projects</h3>
                    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                        <div id="active-filters" class="flex flex-wrap items-center mb-2 md:mb-0">
                            <!-- Active filters will appear here -->
                        </div>
                        <input type="text" id="project-search" placeholder="Search projects..." class="border rounded-md px-3 py-2">
                        <div class="flex space-x-2">
                            <select id="project-filter" class="border rounded-md px-3 py-2">
                                <option value="all">All Status</option>
                                <option value="in-progress">For Review/QA</option>
                                <option value="needs-revision">Needs Revision</option>
                                <option value="completed">Completed</option>
                            </select>
                            <div class="filter-dropdown">
                                <button class="bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    Date Filter
                                </button>
                                <div class="filter-dropdown-content">
                                    <div class="p-2">
                                        <div class="mb-3">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                                            <select id="month-filter" class="w-full border rounded-md px-2 py-1">
                                                <option value="">All Months</option>
                                                <option value="0">January</option>
                                                <option value="1">February</option>
                                                <option value="2">March</option>
                                                <option value="3">April</option>
                                                <option value="4">May</option>
                                                <option value="5">June</option>
                                                <option value="6">July</option>
                                                <option value="7">August</option>
                                                <option value="8">September</option>
                                                <option value="9">October</option>
                                                <option value="10">November</option>
                                                <option value="11">December</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                            <select id="year-filter" class="w-full border rounded-md px-2 py-1">
                                                <option value="">All Years</option>
                                                <option value="2022">2022</option>
                                                <option value="2023">2023</option>
                                                <option value="2024">2024</option>
                                            </select>
                                        </div>
                                        <button id="apply-date-filter" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded-md transition duration-200 text-sm">
                                            Apply Filter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-3 px-4 text-left sortable" data-sort="name">Project Name</th>
                                <th class="py-3 px-4 text-left sortable" data-sort="language">Language</th>
                                <th class="py-3 px-4 text-left sortable" data-sort="owner">Developer</th>
                                <th class="py-3 px-4 text-left sortable" data-sort="dueDate">Due Date</th>
                                <th class="py-3 px-4 text-left sortable" data-sort="status">Status</th>
                                <th class="py-3 px-4 text-left sortable" data-sort="score">Score</th>
                                <th class="py-3 px-4 text-left sortable" data-sort="passStatus">Pass/Fail</th>
                                <th class="py-3 px-4 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projects-table-body">
                            <!-- Projects will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- QA Review Tab -->
        <div id="qa-review" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800">QA Review</h2>
                <div>
                    <select id="qa-mode" class="border rounded-md px-3 py-2 mr-2">
                        <option value="first-draft">First Draft QA</option>
                        <option value="revision">Revision QA</option>
                    </select>
                    <button id="done-qa-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                        DONE
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="col-span-2">
                    <div class="bg-white rounded-lg shadow-sm p-4 h-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Project Information</h3>
                            <div>
                                <select id="qa-project-select" class="border rounded-md px-3 py-2">
                                    <option value="">Select a project</option>
                                    <!-- Projects will be added here -->
                                </select>
                            </div>
                        </div>
                        
                        <div id="qa-project-info" class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-gray-600">Project: <span id="qa-project-name" class="font-medium text-gray-800">-</span></p>
                                    <p class="text-gray-600">Language: <span id="qa-project-language" class="font-medium text-gray-800">-</span></p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Developer: <span id="qa-project-owner" class="font-medium text-gray-800">-</span></p>
                                    <p class="text-gray-600">Due Date: <span id="qa-project-due-date" class="font-medium text-gray-800">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="bg-white rounded-lg shadow-sm p-4 h-full">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Quality Score</h3>
                        <div class="flex flex-col items-center">
                            <div class="text-6xl font-bold text-blue-600 mb-2" id="current-score">4.0</div>
                            <div class="text-sm text-gray-500 mb-4">Current Score</div>
                            
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                                <div class="bg-blue-600 h-2.5 rounded-full" id="score-progress" style="width: 100%"></div>
                            </div>
                            
                            <div class="mt-4 w-full">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-gray-700">Status:</span>
                                    <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800" id="qa-status">Pass</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Findings:</span>
                                    <span class="text-sm text-gray-700" id="findings-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Add Finding</h3>
                    <button id="bulk-import-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Bulk Import CSV
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="finding-lesson" class="block text-gray-700 font-medium mb-2">Lesson</label>
                        <input type="text" id="finding-lesson" class="w-full p-2 border rounded-md" placeholder="e.g., Lesson 3">
                    </div>
                    <div>
                        <label for="finding-category" class="block text-gray-700 font-medium mb-2">Category</label>
                        <select id="finding-category" class="w-full p-2 border rounded-md">
                            <option value="">Select Category</option>
                            <option value="Content">📝 CONTENT</option>
                            <option value="Design">🎨 DESIGN</option>
                            <option value="Function">⚙️ FUNCTIONALITIES</option>
                            <option value="Improvement">🛠️ FOR IMPROVEMENT (minor)</option>
                        </select>
                    </div>
                    <div>
                        <label for="finding-type" class="block text-gray-700 font-medium mb-2">Error Type</label>
                        <select id="finding-type" class="w-full p-2 border rounded-md">
                            <option value="">Select Error Type</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="finding-description" class="block text-gray-700 font-medium mb-2">Description</label>
                    <textarea id="finding-description" class="w-full p-2 border rounded-md h-20" placeholder="Describe the issue..."></textarea>
                </div>
                
                <div class="flex justify-end">
                    <button id="add-finding" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">Add Finding</button>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Findings</h3>
                    <div>
                        <button id="clear-all-findings" class="text-red-600 hover:text-red-800 font-medium text-sm">
                            Clear All
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full" id="findings-table">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-3 px-4 text-left">Lesson</th>
                                <th class="py-3 px-4 text-left">Category</th>
                                <th class="py-3 px-4 text-left">Error Type</th>
                                <th class="py-3 px-4 text-left">Description</th>
                                <th class="py-3 px-4 text-left">Resolved</th>
                                <th class="py-3 px-4 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="findings-table-body">
                            <!-- Findings will be added here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4">
                    <label for="qa-comments" class="block text-gray-700 font-medium mb-2">Additional Comments</label>
                    <textarea id="qa-comments" class="w-full p-2 border rounded-md h-24"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Scoring Reference Tab -->
        <div id="scoring" class="tab-content">
            <div class="bg-green-50 p-4 rounded-lg mb-6">
                <h2 class="text-xl font-semibold text-green-800 mb-2">Scoring Reference</h2>
                <p class="text-green-700">Learn how localization quality scores are calculated and what they mean.</p>
            </div>
            
            <div class="mb-6">
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Scoring Methodology</h4>
                    <p class="text-gray-600 mb-4">The quality score is calculated based on the number of errors found during the QA process.</p>
                    
                    <div class="final-score-note">
                        <p class="font-medium text-blue-800">Final QA Score Calculation:</p>
                        <p class="text-blue-700">When both First Draft and Revision QA scores are available, the Final QA Score is calculated as:</p>
                        <p class="text-blue-700 font-medium mt-1">Final QA Score = (60% × First Draft Score) + (40% × Revision Score)</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <h5 class="font-medium text-gray-700 mb-3 text-center">First Draft QA Scoring</h5>
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-blue-50">
                                        <th class="border p-2">Score</th>
                                        <th class="border p-2">Error Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border p-2 text-center">4.0</td>
                                        <td class="border p-2">No error</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.9</td>
                                        <td class="border p-2">1</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.8</td>
                                        <td class="border p-2">2 to 3</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.7</td>
                                        <td class="border p-2">4</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.6</td>
                                        <td class="border p-2">5</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.0</td>
                                        <td class="border p-2">6</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div>
                            <h5 class="font-medium text-gray-700 mb-3 text-center">Revisions QA Scoring</h5>
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-blue-50">
                                        <th class="border p-2">Score</th>
                                        <th class="border p-2">Error Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border p-2 text-center">4.0</td>
                                        <td class="border p-2">No error</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.8</td>
                                        <td class="border p-2">1</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.7</td>
                                        <td class="border p-2">2</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.6</td>
                                        <td class="border p-2">3</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 text-center">3.0</td>
                                        <td class="border p-2">4</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                        <p class="font-medium text-yellow-800">Important Note:</p>
                        <p class="text-yellow-700">Failure to comply with the QA process will result in an automatic score of 3.0.</p>
                    </div>
                    
                    <div class="mt-6">
                        <h5 class="font-medium text-gray-700 mb-3">Passing Score Threshold</h5>
                        <p class="text-gray-600">A score of <span class="font-medium text-green-600">3.6 or higher</span> is considered a passing score.</p>
                        <p class="text-gray-600 mt-2">For First Draft QA, up to 5 errors are allowed for a passing score.</p>
                        <p class="text-gray-600">For Revisions QA, up to 3 errors are allowed for a passing score.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="add-project-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-add-project">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Add New Project</h2>
            
            <form id="add-project-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="project-name" class="block text-gray-700 font-medium mb-2">Project Name</label>
                        <input type="text" id="project-name" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="project-language" class="block text-gray-700 font-medium mb-2">Target Language</label>
                        <input type="text" id="project-language" class="w-full p-2 border rounded-md" placeholder="Enter target language" required>
                    </div>
                    <div>
                        <label for="project-owner" class="block text-gray-700 font-medium mb-2">Developer</label>
                        <input type="text" id="project-owner" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="project-due-date" class="block text-gray-700 font-medium mb-2">Due Date</label>
                        <input type="date" id="project-due-date" class="w-full p-2 border rounded-md" required>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="project-description" class="block text-gray-700 font-medium mb-2">Project Description</label>
                    <textarea id="project-description" class="w-full p-2 border rounded-md h-24" required></textarea>
                </div>
                
                <div class="flex justify-end">
                    <button type="button" id="cancel-add-project" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200 mr-2">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Details Modal -->
    <div id="project-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-project-details">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Project Details</h2>
            
            <div id="project-details-info" class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-600">Project: <span id="details-project-name" class="font-medium text-gray-800"></span></p>
                        <p class="text-gray-600">Language: <span id="details-project-language" class="font-medium text-gray-800"></span></p>
                        <p class="text-gray-600">Developer: <span id="details-project-owner" class="font-medium text-gray-800"></span></p>
                    </div>
                    <div>
                        <p class="text-gray-600">Due Date: <span id="details-project-due-date" class="font-medium text-gray-800"></span></p>
                        <p class="text-gray-600">Status: <span id="details-project-status" class="font-medium"></span></p>
                        <p class="text-gray-600">Final Score: <span id="details-project-score" class="font-medium"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">QA History</h3>
                <div id="qa-history" class="space-y-4">
                    <!-- QA history will be added here -->
                </div>
            </div>
            
            <div class="flex justify-end">
                <button type="button" id="close-details" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Dialog -->
    <div id="delete-confirm-overlay" class="confirm-overlay" style="display: none;"></div>
    <div id="delete-confirm-dialog" class="confirm-dialog" style="display: none;">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Deletion</h3>
        <p class="text-gray-600 mb-6">Are you sure you want to delete this project? This action cannot be undone.</p>
        <div class="flex justify-end space-x-2">
            <button id="cancel-delete" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">Cancel</button>
            <button id="confirm-delete" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">Delete</button>
        </div>
    </div>

    <!-- Clear Findings Confirmation Dialog -->
    <div id="clear-findings-confirm-overlay" class="confirm-overlay" style="display: none;"></div>
    <div id="clear-findings-confirm-dialog" class="confirm-dialog" style="display: none;">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Clear All Findings</h3>
        <p class="text-gray-600 mb-6">Are you sure you want to clear all findings? This action cannot be undone.</p>
        <div class="flex justify-end space-x-2">
            <button id="cancel-clear-findings" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">Cancel</button>
            <button id="confirm-clear-findings" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">Clear All</button>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csv-import-modal" class="csv-modal">
        <div class="csv-modal-content">
            <span class="close" id="close-csv-import">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Import Findings from CSV</h2>
            
            <div class="mb-6">
                <p class="text-gray-600 mb-4">Upload a CSV file with findings to import them in bulk. The CSV should have the following columns:</p>
                <div class="bg-gray-50 p-3 rounded-md mb-4">
                    <code class="text-sm">Lesson,Category,Error Type,Description</code>
                </div>
                <p class="text-gray-600 mb-2">You can <a href="#" id="download-template" class="text-blue-600 hover:text-blue-800 underline">download a template CSV</a> to get started.</p>
            </div>
            
            <div class="csv-upload-area mb-6" id="csv-upload-area">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="text-gray-700 mb-2">Drag and drop your CSV file here</p>
                <p class="text-gray-500 text-sm mb-4">or</p>
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                <label for="csv-file-input" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 cursor-pointer">
                    Browse Files
                </label>
                <div id="csv-upload-status" class="mt-4"></div>
            </div>
            
            <div class="flex justify-end">
                <button type="button" id="cancel-csv-import" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200 mr-2">Cancel</button>
                <button type="button" id="import-csv" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200" disabled>Import Findings</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span id="toast-message">QA review completed successfully!</span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            // Replace with your Firebase project config
            apiKey: "AIzaSyALpJKhzGVoGqQXwnytw-JKHjBnFEIDM-o",
            authDomain: "qa-log-tracker.firebaseapp.com",
            projectId: "qa-log-tracker",
            storageBucket: "qa-log-tracker.firebasestorage.app",
            messagingSenderId: "50230985322",
            appId: "1:50230985322:web:cfbec24ba3c5bc314ec013"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM Elements for Auth
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const userEmail = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Auth state change listener
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userEmail.textContent = user.email;
                
                // Load data from Firestore
                loadProjectsFromFirestore();
            } else {
                // User is signed out
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                
                // Clear any loaded data
                projects = [];
            }
            
            // Hide loading overlay
            loadingOverlay.style.display = 'none';
        });
        
        // Login button click
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }
            
            loadingOverlay.style.display = 'flex';
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    showAuthError(error.message);
                });
        });
        
        // Signup button click
        signupBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('Password should be at least 6 characters');
                return;
            }
            
            loadingOverlay.style.display = 'flex';
            
            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    showAuthError(error.message);
                });
        });
        
        // Logout button click
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
        
        // Show auth error
        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }
        
        // Global projects array
let projects = [];

// Load projects from Firestore
function loadProjectsFromFirestore() {
    loadingOverlay.style.display = 'flex';
    
    db.collection('projects')
        .where('userId', '==', auth.currentUser.uid)
        .get()
        .then(snapshot => {
            projects = [];
            snapshot.forEach(doc => {
                const project = doc.data();
                project.id = doc.id;
                projects.push(project);
            });
            
            // Initialize the dashboard with loaded data
            initDashboard();
            loadingOverlay.style.display = 'none';
        })
        .catch(error => {
            console.error("Error loading projects: ", error);
            loadingOverlay.style.display = 'none';
            showToast('Error loading projects. Please try again.');
        });
}

// Save project to Firestore
function saveProjectToFirestore(project) {
    // Remove the id field if it exists (will be the document ID)
    const projectData = {...project};
    delete projectData.id;
    
    // Add user ID to the project
    projectData.userId = auth.currentUser.uid;
    
    return db.collection('projects').add(projectData)
        .then(docRef => {
            // Return the new document ID
            return docRef.id;
        });
}

// Update project in Firestore
function updateProjectInFirestore(project) {
    // Create a copy of the project without the id
    const projectData = {...project};
    const projectId = projectData.id;
    delete projectData.id;
    
    return db.collection('projects').doc(projectId).update(projectData);
}

// Delete project from Firestore
function deleteProjectFromFirestore(projectId) {
    return db.collection('projects').doc(projectId).delete();
}

// Modified add project form submission
addProjectForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const newProject = {
        name: document.getElementById('project-name').value,
        language: document.getElementById('project-language').value,
        owner: document.getElementById('project-owner').value,
        dueDate: document.getElementById('project-due-date').value,
        status: 'in-progress',
        score: null,
        description: document.getElementById('project-description').value,
        qaHistory: [],
        finalScore: null,
        createdAt: new Date().toISOString()
    };
    
    loadingOverlay.style.display = 'flex';
    
    saveProjectToFirestore(newProject)
        .then(id => {
            newProject.id = id;
            projects.push(newProject);
            
            updateProjectsTable();
            updateProjectStats();
            updateDeveloperPerformance();
            populateQaProjectSelect();
            
            addProjectModal.style.display = 'none';
            addProjectForm.reset();
            
            showToast('Project added successfully!');
            loadingOverlay.style.display = 'none';
        })
        .catch(error => {
            console.error("Error adding project: ", error);
            loadingOverlay.style.display = 'none';
            showToast('Error adding project. Please try again.');
        });
});

// Modified delete project function
function deleteProject(projectId) {
    loadingOverlay.style.display = 'flex';
    
    deleteProjectFromFirestore(projectId)
        .then(() => {
            projects = projects.filter(p => p.id !== projectId);
            
            updateProjectsTable();
            updateProjectStats();
            updateDeveloperPerformance();
            populateQaProjectSelect();
            
            showToast('Project deleted successfully!');
            loadingOverlay.style.display = 'none';
        })
        .catch(error => {
            console.error("Error deleting project: ", error);
            loadingOverlay.style.display = 'none';
            showToast('Error deleting project. Please try again.');
        });
}

// Modified done QA button
doneQaBtn.addEventListener('click', () => {
    const projectId = qaProjectSelect.value;
    if (!projectId) {
        alert('Please select a project');
        return;
    }
    
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    const score = parseFloat(currentScore.textContent);
    const status = score >= 3.6 ? 'pass' : 'fail';
    const comments = document.getElementById('qa-comments').value;
    const mode = qaMode.value;
    
    // Collect findings
    const findings = [];
    document.querySelectorAll('#findings-table-body tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        // Remove emoji from category
        const categoryWithEmoji = cells[1].textContent;
        const category = categoryWithEmoji.replace(/[\u{1F300}-\u{1F5FF}\u{1F900}-\u{1F9FF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F1E6}-\u{1F1FF}\u{1F191}-\u{1F251}\u{1F004}\u{1F0CF}\u{1F170}-\u{1F171}\u{1F17E}-\u{1F17F}\u{1F18E}\u{3030}\u{2B50}\u{2B55}\u{2934}-\u{2935}\u{2B05}-\u{2B07}\u{2B1B}-\u{2B1C}\u{3297}\u{3299}\u{303D}\u{00A9}\u{00AE}\u{2122}\u{23F3}\u{24C2}\u{23E9}-\u{23EF}\u{25AA}-\u{25AB}\u{25B6}\u{25C0}\u{25FB}-\u{25FE}\u{2600}-\u{2604}\u{260E}\u{2611}\u{2614}-\u{2615}\u{2618}\u{261D}\u{2620}\u{2622}-\u{2623}\u{2626}\u{262A}\u{262E}-\u{262F}\u{2638}-\u{263A}\u{2640}\u{2642}\u{2648}-\u{2653}\u{265F}-\u{2660}\u{2663}\u{2665}-\u{2666}\u{2668}\u{267B}\u{267E}-\u{267F}\u{2692}-\u{2697}\u{2699}\u{269B}-\u{269C}\u{26A0}-\u{26A1}\u{26AA}-\u{26AB}\u{26B0}-\u{26B1}\u{26BD}-\u{26BE}\u{26C4}-\u{26C5}\u{26C8}\u{26CE}-\u{26CF}\u{26D1}\u{26D3}-\u{26D4}\u{26E9}-\u{26EA}\u{26F0}-\u{26F5}\u{26F7}-\u{26FA}\u{26FD}\u{2702}\u{2705}\u{2708}-\u{270D}\u{270F}\u{2712}\u{2714}\u{2716}\u{271D}\u{2721}\u{2728}\u{2733}-\u{2734}\u{2744}\u{2747}\u{274C}\u{274E}\u{2753}-\u{2755}\u{2757}\u{2763}-\u{2764}\u{2795}-\u{2797}\u{27A1}\u{27B0}\u{27BF}\u{2934}-\u{2935}\u{2B05}-\u{2B07}\u{2B1B}-\u{2B1C}\u{2B50}\u{2B55}\u{3030}\u{303D}\u{3297}\u{3299}]/gu, '').trim();
        
        findings.push({
            lesson: cells[0].textContent,
            category: category,
            type: cells[2].textContent,
            description: cells[3].querySelector('.tooltip-text').textContent,
            resolved: cells[4].querySelector('input').checked
        });
    });
    
    // Create QA review
    const qaReview = {
        reviewer: auth.currentUser.email,
        date: new Date().toISOString().split('T')[0],
        score: score,
        qaType: mode,
        status: status,
        comments: comments,
        findings: findings
    };
    
    // Add QA review to project history
    project.qaHistory.push(qaReview);
    
    // Update project status and score
    if (status === 'pass') {
        project.status = 'completed';
    } else {
        project.status = 'needs-revision';
    }
    
    project.score = score;
    
    // Calculate final score if both QA types are available
    const hasFirstDraft = project.qaHistory.some(qa => qa.qaType === 'first-draft');
    const hasRevision = project.qaHistory.some(qa => qa.qaType === 'revision');
    
    if (hasFirstDraft && hasRevision) {
        const firstDraftScore = project.qaHistory.find(qa => qa.qaType === 'first-draft').score;
        const revisionScore = project.qaHistory.find(qa => qa.qaType === 'revision').score;
        
        // Final score formula: (60% × First Draft Score) + (40% × Revision Score)
        project.finalScore = (0.6 * firstDraftScore) + (0.4 * revisionScore);
    }
    
    loadingOverlay.style.display = 'flex';
    
    updateProjectInFirestore(project)
        .then(() => {
            // Update UI
            updateProjectsTable();
            updateProjectStats();
            updateDeveloperPerformance();
            
            // Reset QA form
            qaProjectSelect.value = '';
            document.getElementById('qa-project-name').textContent = '-';
            document.getElementById('qa-project-language').textContent = '-';
            document.getElementById('qa-project-owner').textContent = '-';
            document.getElementById('qa-project-due-date').textContent = '-';
            findingsTableBody.innerHTML = '';
            currentScore.textContent = '4.0';
            scoreProgress.style.width = '100%';
            scoreProgress.style.backgroundColor = '#3B82F6';
            qaStatus.textContent = 'Pass';
            qaStatus.className = 'px-2 py-1 rounded-full text-xs bg-green-100 text-green-800';
            findingsCount.textContent = '0';
            document.getElementById('qa-comments').value = '';
            
            showToast('QA review completed successfully!');
            loadingOverlay.style.display = 'none';
        })
        .catch(error => {
            console.error("Error updating project: ", error);
            loadingOverlay.style.display = 'none';
            showToast('Error saving QA review. Please try again.');
        });
});

// Error types by category
const errorTypes = {
    "Content": [
        "Text-based content are not translated",
        "Player labels are not translated",
        "Other assets that are expected to be translated are not translated",
        "Spelling and grammatical errors",
        "Missing information from reference material",
        "Intended media attachments are not included or inaccessible",
        "Transcripts have discrepancies",
        "Punctuation marks in bullet points are inconsistent"
    ],
    "Design": [
        "Visual assets are overlapping",
        "Branding is not applied",
        "Missed keyouts",
        "Animation has glitches and obvious mistakes",
        "Animation timing/transition is incorrect",
        "Intro and/or outro clips are not included",
        "Henkel/Product branding is not applied",
        "Visual components are misaligned",
        "Image/icon styles are inconsistent",
        "Image/icon resolution is distorted/stretched",
        "Placement of constant items in the course is inconsistent",
        "Font used is not standard"
    ],
    "Function": [
        "Voiceover is not synced with the content",
        "Voiceovers are overlapping",
        "Voiceovers lack pauses (for text-to-speech only)",
        "Audio track in mono",
        "Audio track has bad cuts",
        "Built-in components have discrepancies",
        "Custom interaction is disruptive"
    ],
    "Improvement": [
        "Images/videos from requesters are low quality",
        "Text highlights are missing",
        "Audio tracks are unleveled",
        "If animation cannot be synced with voiceover, developers can show everything at once with proper transition",
        "Images imposed by SME/requester are blurred",
        "Video/Animation is in low resolution"
    ]
};

// CSV parsing variables
let csvData = null;

// DOM elements
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
const projectsTableBody = document.getElementById('projects-table-body');
const addProjectBtn = document.getElementById('add-project-btn');
const addProjectModal = document.getElementById('add-project-modal');
const closeAddProject = document.getElementById('close-add-project');
const cancelAddProject = document.getElementById('cancel-add-project');
const addProjectForm = document.getElementById('add-project-form');
const projectDetailsModal = document.getElementById('project-details-modal');
const closeProjectDetails = document.getElementById('close-project-details');
const closeDetails = document.getElementById('close-details');
const findingCategory = document.getElementById('finding-category');
const findingType = document.getElementById('finding-type');
const addFinding = document.getElementById('add-finding');
const findingsTableBody = document.getElementById('findings-table-body');
const currentScore = document.getElementById('current-score');
const scoreProgress = document.getElementById('score-progress');
const qaStatus = document.getElementById('qa-status');
const findingsCount = document.getElementById('findings-count');
const doneQaBtn = document.getElementById('done-qa-btn');
const qaProjectSelect = document.getElementById('qa-project-select');
const qaMode = document.getElementById('qa-mode');
const projectSearch = document.getElementById('project-search');
const projectFilter = document.getElementById('project-filter');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');
const monthFilter = document.getElementById('month-filter');
const yearFilter = document.getElementById('year-filter');
const applyDateFilter = document.getElementById('apply-date-filter');
const activeFilters = document.getElementById('active-filters');
const deleteConfirmOverlay = document.getElementById('delete-confirm-overlay');
const deleteConfirmDialog = document.getElementById('delete-confirm-dialog');
const cancelDelete = document.getElementById('cancel-delete');
const confirmDelete = document.getElementById('confirm-delete');
const sortableHeaders = document.querySelectorAll('.sortable');
const dateFilterBtn = document.getElementById('date-filter-btn');
const dateFilterPanel = document.getElementById('date-filter-panel');
const dashboardMonthFilter = document.getElementById('dashboard-month-filter');
const dashboardYearFilter = document.getElementById('dashboard-year-filter');
const applyDashboardFilter = document.getElementById('apply-dashboard-filter');
const resetDashboardFilter = document.getElementById('reset-dashboard-filter');
const clearDashboardFilter = document.getElementById('clear-dashboard-filter');
const dashboardFilterInfo = document.getElementById('dashboard-filter-info');
const dashboardFilterText = document.getElementById('dashboard-filter-text');
const developerSort = document.getElementById('developer-sort');
const bulkImportBtn = document.getElementById('bulk-import-btn');
const csvImportModal = document.getElementById('csv-import-modal');
const closeCsvImport = document.getElementById('close-csv-import');
const cancelCsvImport = document.getElementById('cancel-csv-import');
const csvFileInput = document.getElementById('csv-file-input');
const csvUploadArea = document.getElementById('csv-upload-area');
const csvUploadStatus = document.getElementById('csv-upload-status');
const importCsvBtn = document.getElementById('import-csv');
const downloadTemplateBtn = document.getElementById('download-template');
const clearAllFindings = document.getElementById('clear-all-findings');
const clearFindingsConfirmOverlay = document.getElementById('clear-findings-confirm-overlay');
const clearFindingsConfirmDialog = document.getElementById('clear-findings-confirm-dialog');
const cancelClearFindings = document.getElementById('cancel-clear-findings');
const confirmClearFindings = document.getElementById('confirm-clear-findings');

// Current filters
let currentFilters = {
    month: null,
    year: null,
    status: 'all',
    search: ''
};

// Dashboard filters
let dashboardFilters = {
    month: null,
    year: null
};

// Current sort
let currentSort = {
    column: 'name',
    direction: 'asc'
};

// Developer sort
let developerSortOption = 'score';

// Project to delete
let projectToDelete = null;

// Initialize the dashboard
function initDashboard() {
    updateProjectsTable();
    updateProjectStats();
    updateDeveloperPerformance();
    populateQaProjectSelect();
    initSortableHeaders();
    setupCSVUpload();
    
    // Set up date filter panel toggle
    dateFilterBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dateFilterPanel.classList.toggle('show');
    });
    
    // Close date filter panel when clicking outside
    document.addEventListener('click', (e) => {
        if (!dateFilterPanel.contains(e.target) && e.target !== dateFilterBtn) {
            dateFilterPanel.classList.remove('show');
        }
    });
    
    // Apply dashboard filter
    applyDashboardFilter.addEventListener('click', () => {
        const monthValue = dashboardMonthFilter.value;
        const yearValue = dashboardYearFilter.value;
        
        dashboardFilters.month = monthValue === '' ? null : parseInt(monthValue);
        dashboardFilters.year = yearValue === '' ? null : parseInt(yearValue);
        
        updateDashboardFilterDisplay();
        updateProjectStats();
        updateDeveloperPerformance();
        
        dateFilterPanel.classList.remove('show');
    });
    
    // Reset dashboard filter
    resetDashboardFilter.addEventListener('click', () => {
        dashboardMonthFilter.value = '';
        dashboardYearFilter.value = '';
        dashboardFilters.month = null;
        dashboardFilters.year = null;
        
        updateDashboardFilterDisplay();
        updateProjectStats();
        updateDeveloperPerformance();
    });
    
    // Clear dashboard filter
    clearDashboardFilter.addEventListener('click', () => {
        dashboardMonthFilter.value = '';
        dashboardYearFilter.value = '';
        dashboardFilters.month = null;
        dashboardFilters.year = null;
        
        updateDashboardFilterDisplay();
        updateProjectStats();
        updateDeveloperPerformance();
    });
    
    // Developer sort change
    developerSort.addEventListener('change', () => {
        developerSortOption = developerSort.value;
        updateDeveloperPerformance();
    });
    
    // Bulk import button
    bulkImportBtn.addEventListener('click', () => {
        openCsvImportModal();
    });
    
    // Clear all findings button
    clearAllFindings.addEventListener('click', () => {
        showClearFindingsConfirmation();
    });
}

// Update dashboard filter display
function updateDashboardFilterDisplay() {
    if (dashboardFilters.month !== null || dashboardFilters.year !== null) {
        let filterText = 'Showing data for: ';
        
        if (dashboardFilters.month !== null) {
            filterText += getMonthName(dashboardFilters.month);
            
            if (dashboardFilters.year !== null) {
                filterText += ' ' + dashboardFilters.year;
            }
        } else if (dashboardFilters.year !== null) {
            filterText += 'Year ' + dashboardFilters.year;
        }
        
        dashboardFilterText.textContent = filterText;
        dashboardFilterInfo.classList.remove('hidden');
    } else {
        dashboardFilterInfo.classList.add('hidden');
    }
}

// Initialize sortable headers
function initSortableHeaders() {
    sortableHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const column = header.getAttribute('data-sort');
            
            // If clicking the same column, toggle direction
            if (column === currentSort.column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to ascending
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update header classes
            sortableHeaders.forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            
            header.classList.add(currentSort.direction);
            
            // Update table
            updateProjectsTable();
        });
    });
}

// Tab switching
tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabId = tab.getAttribute('data-tab');
        tabContents.forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
    });
});

// Update projects table
function updateProjectsTable(filteredProjects = null) {
    if (!filteredProjects) {
        filteredProjects = filterProjects();
    }
    
    // Sort projects
    filteredProjects = sortProjects(filteredProjects);
    
    projectsTableBody.innerHTML = '';
    
    if (filteredProjects.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="8" class="text-center py-4 text-gray-500">No projects found</td>
        `;
        projectsTableBody.appendChild(row);
        return;
    }
    
    filteredProjects.forEach(project => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        let statusClass = '';
        let statusText = '';
        
        switch(project.status) {
            case 'in-progress':
                statusClass = 'bg-blue-100 text-blue-800';
                statusText = 'For Review/QA';
                break;
            case 'needs-revision':
                statusClass = 'bg-red-100 text-red-800';
                statusText = 'Needs Revision';
                break;
            case 'completed':
                statusClass = 'bg-green-100 text-green-800';
                statusText = 'Completed';
                break;
        }
        
        // Display final score if available, otherwise display the current score
        let scoreDisplay = project.finalScore !== null ? project.finalScore.toFixed(1) : 
                          (project.score !== null ? project.score.toFixed(1) : '-');
        let passFailDisplay = '';
        
        if (project.finalScore !== null || project.score !== null) {
            const displayScore = project.finalScore !== null ? project.finalScore : project.score;
            passFailDisplay = displayScore >= 3.6 ? 
                '<span class="text-green-600 font-medium">Pass</span>' : 
                '<span class="text-red-600 font-medium">Fail</span>';
        } else {
            passFailDisplay = '-';
        }
        
        row.innerHTML = `
            <td class="py-3 px-4 border-b font-medium">${project.name}</td>
            <td class="py-3 px-4 border-b">${project.language}</td>
            <td class="py-3 px-4 border-b">${project.owner}</td>
            <td class="py-3 px-4 border-b">${formatDate(project.dueDate)}</td>
            <td class="py-3 px-4 border-b"><span class="px-2 py-1 rounded-full text-xs ${statusClass}">${statusText}</span></td>
            <td class="py-3 px-4 border-b font-medium">${scoreDisplay}</td>
            <td class="py-3 px-4 border-b">${passFailDisplay}</td>
            <td class="py-3 px-4 border-b">
                <div class="flex space-x-2">
                    ${project.status === 'in-progress' || project.status === 'needs-revision' ? 
                        `<button class="qa-review-btn bg-blue-600 hover:bg-blue-700 text-white text-sm py-1 px-3 rounded" data-id="${project.id}">QA Review</button>` : 
                        `<button class="view-qa-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-1 px-3 rounded" data-id="${project.id}">View QA</button>`
                    }
                    <button class="delete-project-btn delete-btn" data-id="${project.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </td>
        `;
        
        projectsTableBody.appendChild(row);
    });
    
    // Add event listeners to buttons
    document.querySelectorAll('.qa-review-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const projectId = btn.getAttribute('data-id');
            qaProjectSelect.value = projectId;
            qaProjectSelect.dispatchEvent(new Event('change'));
            
            // Switch to QA Review tab
            document.querySelector('[data-tab="qa-review"]').click();
        });
    });
    
    document.querySelectorAll('.view-qa-btn').forEach(btn => {
        btn.addEventListener('click', () => openProjectDetails(btn.getAttribute('data-id')));
    });
    
    document.querySelectorAll('.delete-project-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const projectId = btn.getAttribute('data-id');
            showDeleteConfirmation(projectId);
        });
    });
}

// Sort projects
function sortProjects(projectsList) {
    return projectsList.sort((a, b) => {
        let valueA, valueB;
        
        // Handle special cases for sorting
        switch(currentSort.column) {
            case 'name':
            case 'language':
                valueA = a[currentSort.column].toLowerCase();
                valueB = b[currentSort.column].toLowerCase();
                break;
            case 'owner':
                valueA = a.owner.toLowerCase();
                valueB = b.owner.toLowerCase();
                break;
            case 'dueDate':
                valueA = new Date(a.dueDate);
                valueB = new Date(b.dueDate);
                break;
            case 'status':
                // Custom order: in-progress, needs-revision, completed
                const statusOrder = { 'in-progress': 1, 'needs-revision': 2, 'completed': 3 };
                valueA = statusOrder[a.status];
                valueB = statusOrder[b.status];
                break;
            case 'score':
                valueA = a.finalScore !== null ? a.finalScore : (a.score !== null ? a.score : -1);
                valueB = b.finalScore !== null ? b.finalScore : (b.score !== null ? b.score : -1);
                break;
            case 'passStatus':
                // Pass/Fail based on score
                const scoreA = a.finalScore !== null ? a.finalScore : (a.score !== null ? a.score : -1);
                const scoreB = b.finalScore !== null ? b.finalScore : (b.score !== null ? b.score : -1);
                valueA = scoreA >= 3.6 ? 1 : (scoreA === -1 ? 2 : 0); // Pass = 1, Fail = 0, No score = 2
                valueB = scoreB >= 3.6 ? 1 : (scoreB === -1 ? 2 : 0);
                break;
            default:
                valueA = a[currentSort.column];
                valueB = b[currentSort.column];
        }
        
        // Compare values based on direction
        if (currentSort.direction === 'asc') {
            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        } else {
            if (valueA > valueB) return -1;
            if (valueA < valueB) return 1;
            return 0;
        }
    });
}

// Show delete confirmation dialog
function showDeleteConfirmation(projectId) {
    projectToDelete = projectId;
    deleteConfirmOverlay.style.display = 'block';
    deleteConfirmDialog.style.display = 'block';
}

// Hide delete confirmation dialog
function hideDeleteConfirmation() {
    deleteConfirmOverlay.style.display = 'none';
    deleteConfirmDialog.style.display = 'none';
    projectToDelete = null;
}

// Cancel delete button
cancelDelete.addEventListener('click', hideDeleteConfirmation);

// Confirm delete button
confirmDelete.addEventListener('click', () => {
    if (projectToDelete) {
        deleteProject(projectToDelete);
        hideDeleteConfirmation();
    }
});

// Show clear findings confirmation dialog
function showClearFindingsConfirmation() {
    clearFindingsConfirmOverlay.style.display = 'block';
    clearFindingsConfirmDialog.style.display = 'block';
}

// Hide clear findings confirmation dialog
function hideClearFindingsConfirmation() {
    clearFindingsConfirmOverlay.style.display = 'none';
    clearFindingsConfirmDialog.style.display = 'none';
}

// Clear all findings
function clearAllFindingsAction() {
    findingsTableBody.innerHTML = '';
    updateScore();
    showToast('All findings cleared successfully!');
}

// Cancel clear findings button
cancelClearFindings.addEventListener('click', hideClearFindingsConfirmation);

// Confirm clear findings button
confirmClearFindings.addEventListener('click', () => {
    clearAllFindingsAction();
    hideClearFindingsConfirmation();
});

// Filter projects based on current filters
function filterProjects() {
    return projects.filter(project => {
        // Search filter
        const searchMatch = currentFilters.search === '' || 
            project.name.toLowerCase().includes(currentFilters.search.toLowerCase()) || 
            project.language.toLowerCase().includes(currentFilters.search.toLowerCase()) ||
            project.owner.toLowerCase().includes(currentFilters.search.toLowerCase());
        
        // Status filter
        const statusMatch = currentFilters.status === 'all' || project.status === currentFilters.status;
        
        // Date filters
        let dateMatch = true;
        const dueDate = new Date(project.dueDate);
        
        if (currentFilters.month !== null) {
            dateMatch = dateMatch && dueDate.getMonth() === currentFilters.month;
        }
        
        if (currentFilters.year !== null) {
            dateMatch = dateMatch && dueDate.getFullYear() === currentFilters.year;
        }
        
        return searchMatch && statusMatch && dateMatch;
    });
}

// Filter projects for dashboard stats
function filterProjectsForDashboard() {
    return projects.filter(project => {
        // Date filters
        let dateMatch = true;
        
        // Use the most recent QA date for filtering
        let qaDate = null;
        if (project.qaHistory && project.qaHistory.length > 0) {
            // Sort QA history by date (newest first)
            const sortedQA = [...project.qaHistory].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            qaDate = new Date(sortedQA[0].date);
        } else {
            // If no QA history, use due date
            qaDate = new Date(project.dueDate);
        }
        
        if (dashboardFilters.month !== null) {
            dateMatch = dateMatch && qaDate.getMonth() === dashboardFilters.month;
        }
        
        if (dashboardFilters.year !== null) {
            dateMatch = dateMatch && qaDate.getFullYear() === dashboardFilters.year;
        }
        
        return dateMatch;
    });
}

// Calculate average QA score
function calculateAverageQAScore(filteredProjects) {
    const projectsWithScores = filteredProjects.filter(p => p.finalScore !== null || p.score !== null);
    
    if (projectsWithScores.length === 0) {
        return 0;
    }
    
    const totalScore = projectsWithScores.reduce((sum, project) => {
        return sum + (project.finalScore !== null ? project.finalScore : project.score);
    }, 0);
    
    return totalScore / projectsWithScores.length;
}

// Update project statistics
function updateProjectStats() {
    const filteredProjects = filterProjectsForDashboard();
    
    document.getElementById('total-projects').textContent = filteredProjects.length;
    document.getElementById('in-progress-projects').textContent = filteredProjects.filter(p => p.status === 'in-progress').length;
    document.getElementById('needs-revision-projects').textContent = filteredProjects.filter(p => p.status === 'needs-revision').length;
    document.getElementById('completed-projects').textContent = filteredProjects.filter(p => p.status === 'completed').length;
    
    // Calculate and display average QA score
    const avgScore = calculateAverageQAScore(filteredProjects);
    document.getElementById('average-qa-score').textContent = avgScore.toFixed(1);
}

// Update developer performance section
function updateDeveloperPerformance() {
    const filteredProjects = filterProjectsForDashboard();
    const developerScores = calculateDeveloperScores(filteredProjects);
    
    // Sort developers based on selected option
    let sortedDevelopers = [...developerScores];
    
    switch (developerSortOption) {
        case 'name':
            sortedDevelopers.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'score':
            sortedDevelopers.sort((a, b) => b.averageScore - a.averageScore);
            break;
        case 'projects':
            sortedDevelopers.sort((a, b) => b.totalProjects - a.totalProjects);
            break;
    }
    
    // Update developer score cards
    updateDeveloperScoreCards(sortedDevelopers);
    
    // Update developer chart
    updateDeveloperChart(sortedDevelopers);
}

// Calculate developer scores
function calculateDeveloperScores(filteredProjects) {
    const developers = {};
    
    filteredProjects.forEach(project => {
        const developer = project.owner;
        const score = project.finalScore !== null ? project.finalScore : project.score;
        
        if (!developers[developer]) {
            developers[developer] = {
                name: developer,
                totalProjects: 0,
                completedProjects: 0,
                totalScore: 0,
                averageScore: 0,
                passRate: 0,
                projectsWithScores: 0
            };
        }
        
        developers[developer].totalProjects++;
        
        if (project.status === 'completed') {
            developers[developer].completedProjects++;
        }
        
        if (score !== null) {
            developers[developer].totalScore += score;
            developers[developer].projectsWithScores++;
        }
    });
    
    // Calculate averages and pass rates
    Object.values(developers).forEach(dev => {
        if (dev.projectsWithScores > 0) {
            dev.averageScore = dev.totalScore / dev.projectsWithScores;
        }
        
        if (dev.totalProjects > 0) {
            dev.passRate = (dev.completedProjects / dev.totalProjects) * 100;
        }
    });
    
    return Object.values(developers);
}

// Update developer score cards
function updateDeveloperScoreCards(developers) {
    const developerScoresContainer = document.getElementById('developer-scores');
    developerScoresContainer.innerHTML = '';
    
    if (developers.length === 0) {
        developerScoresContainer.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">No developer data available for the selected period</div>';
        return;
    }
    
    developers.forEach(dev => {
        // Determine color based on average score
        let borderColor, textColor;
        if (dev.averageScore >= 3.8) {
            borderColor = 'border-green-500';
            textColor = 'text-green-600';
        } else if (dev.averageScore >= 3.6) {
            borderColor = 'border-blue-500';
            textColor = 'text-blue-600';
        } else if (dev.averageScore > 0) {
            borderColor = 'border-red-500';
            textColor = 'text-red-600';
        } else {
            borderColor = 'border-gray-300';
            textColor = 'text-gray-600';
        }
        
        const card = document.createElement('div');
        card.className = `developer-score-card bg-white p-4 rounded-lg shadow-sm ${borderColor}`;
        
        card.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold text-gray-800">${dev.name}</h4>
                <span class="text-sm text-gray-500">${dev.totalProjects} project${dev.totalProjects !== 1 ? 's' : ''}</span>
            </div>
            <div class="flex items-end justify-between">
                <div>
                    <p class="text-sm text-gray-600">Average QA Score</p>
                    <p class="text-2xl font-bold ${textColor}">${dev.averageScore > 0 ? dev.averageScore.toFixed(1) : 'N/A'}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Pass Rate</p>
                    <p class="text-lg font-semibold ${dev.passRate >= 80 ? 'text-green-600' : dev.passRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                        ${dev.passRate.toFixed(0)}%
                    </p>
                </div>
            </div>
            <div class="mt-2">
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full ${dev.passRate >= 80 ? 'bg-green-500' : dev.passRate >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                        style="width: ${dev.passRate}%"></div>
                </div>
            </div>
        `;
        
        developerScoresContainer.appendChild(card);
    });
}

// Update developer chart
function updateDeveloperChart(developers) {
    const chartContainer = document.getElementById('developer-score-chart');
    chartContainer.innerHTML = '';
    
    if (developers.length === 0) {
        return;
    }
    
    // Limit to top 10 developers if needed
    const displayDevelopers = developers.slice(0, 10);
    
    // Calculate positions
    const chartWidth = chartContainer.offsetWidth;
    const barWidth = 30;
    const spacing = Math.min(50, (chartWidth - (displayDevelopers.length * barWidth)) / (displayDevelopers.length + 1));
    
    displayDevelopers.forEach((dev, index) => {
        if (dev.averageScore > 0) {
            // Calculate height (max height is 180px for score 4.0)
            const heightPercentage = (dev.averageScore / 4) * 100;
            const height = (heightPercentage / 100) * 180;
            
            // Determine color based on average score
            let barColor;
            if (dev.averageScore >= 3.8) {
                barColor = '#10B981'; // green-500
            } else if (dev.averageScore >= 3.6) {
                barColor = '#3B82F6'; // blue-500
            } else {
                barColor = '#EF4444'; // red-500
            }
            
            // Create bar
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            bar.style.left = `${spacing + (index * (barWidth + spacing))}px`;
            bar.style.height = `${height}px`;
            bar.style.backgroundColor = barColor;
            
            // Create label
            const label = document.createElement('div');
            label.className = 'chart-label';
            label.style.left = `${spacing + (index * (barWidth + spacing))}px`;
            label.textContent = dev.name;
            
            // Create value
            const value = document.createElement('div');
            value.className = 'chart-value';
            value.style.left = `${spacing + (index * (barWidth + spacing))}px`;
            value.textContent = dev.averageScore.toFixed(1);
            
            // Add tooltip
            bar.title = `${dev.name}: ${dev.averageScore.toFixed(1)} (${dev.totalProjects} projects)`;
            
            chartContainer.appendChild(bar);
            chartContainer.appendChild(label);
            chartContainer.appendChild(value);
        }
    });
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Get month name
function getMonthName(monthIndex) {
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return months[monthIndex];
}

// Update active filters display
function updateActiveFilters() {
    activeFilters.innerHTML = '';
    
    if (currentFilters.month !== null) {
        const monthBadge = document.createElement('div');
        monthBadge.className = 'date-filter-badge';
        monthBadge.innerHTML = `
            <span>Month: ${getMonthName(currentFilters.month)}</span>
            <button class="clear-month-filter">×</button>
        `;
        activeFilters.appendChild(monthBadge);
        
        monthBadge.querySelector('.clear-month-filter').addEventListener('click', () => {
            currentFilters.month = null;
            monthFilter.value = '';
            updateActiveFilters();
            updateProjectsTable();
        });
    }
    
    if (currentFilters.year !== null) {
        const yearBadge = document.createElement('div');
        yearBadge.className = 'date-filter-badge';
        yearBadge.innerHTML = `
            <span>Year: ${currentFilters.year}</span>
            <button class="clear-year-filter">×</button>
        `;
        activeFilters.appendChild(yearBadge);
        
        yearBadge.querySelector('.clear-year-filter').addEventListener('click', () => {
            currentFilters.year = null;
            yearFilter.value = '';
            updateActiveFilters();
            updateProjectsTable();
        });
    }
}

// Add project modal
addProjectBtn.addEventListener('click', () => {
    addProjectModal.style.display = 'block';
});

closeAddProject.addEventListener('click', () => {
    addProjectModal.style.display = 'none';
});

cancelAddProject.addEventListener('click', () => {
    addProjectModal.style.display = 'none';
});

// Project details modal
function openProjectDetails(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    document.getElementById('details-project-name').textContent = project.name;
    document.getElementById('details-project-language').textContent = project.language;
    document.getElementById('details-project-owner').textContent = project.owner;
    document.getElementById('details-project-due-date').textContent = formatDate(project.dueDate);
    
    const statusElem = document.getElementById('details-project-status');
    statusElem.textContent = project.status === 'in-progress' ? 'For Review/QA' : 
                            project.status === 'needs-revision' ? 'Needs Revision' : 'Completed';
    statusElem.className = project.status === 'in-progress' ? 'font-medium text-blue-600' : 
                        project.status === 'needs-revision' ? 'font-medium text-red-600' : 'font-medium text-green-600';
    
    const scoreElem = document.getElementById('details-project-score');
    
    // Display final score if available, otherwise display the current score
    if (project.finalScore !== null) {
        scoreElem.textContent = project.finalScore.toFixed(1);
        scoreElem.className = project.finalScore >= 3.6 ? 'font-medium text-green-600' : 'font-medium text-red-600';
    } else if (project.score !== null) {
        scoreElem.textContent = project.score.toFixed(1);
        scoreElem.className = project.score >= 3.6 ? 'font-medium text-green-600' : 'font-medium text-red-600';
    } else {
        scoreElem.textContent = 'Not reviewed';
        scoreElem.className = 'font-medium text-gray-600';
    }
    
    // Populate QA history
    const qaHistoryContainer = document.getElementById('qa-history');
    qaHistoryContainer.innerHTML = '';
    
    if (project.qaHistory.length === 0) {
        qaHistoryContainer.innerHTML = '<p class="text-gray-500">No QA reviews yet.</p>';
    } else {
        // Check if we have both first draft and revision QA
        const hasFirstDraft = project.qaHistory.some(qa => qa.qaType === 'first-draft');
        const hasRevision = project.qaHistory.some(qa => qa.qaType === 'revision');
        const hasFinalScore = hasFirstDraft && hasRevision;
        
        // Add final score section if both QA types exist
        if (hasFinalScore) {
            const finalScoreItem = document.createElement('div');
            finalScoreItem.className = 'bg-white p-4 rounded-lg shadow-sm';
            
            const firstDraftScore = project.qaHistory.find(qa => qa.qaType === 'first-draft').score;
            const revisionScore = project.qaHistory.find(qa => qa.qaType === 'revision').score;
            const finalScore = project.finalScore;
            
            finalScoreItem.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <span class="qa-type-badge final-score-badge">Final Score</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Score: </span>
                        <span class="font-medium ${finalScore >= 3.6 ? 'text-green-600' : 'text-red-600'}">${finalScore.toFixed(1)}</span>
                        <span class="ml-2 px-2 py-1 rounded-full text-xs ${finalScore >= 3.6 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${finalScore >= 3.6 ? 'Pass' : 'Fail'}
                        </span>
                    </div>
                </div>
                <div class="text-gray-700">
                    <p>Calculated as: (60% × First Draft Score) + (40% × Revision Score)</p>
                    <p class="mt-1">= (60% × ${firstDraftScore.toFixed(1)}) + (40% × ${revisionScore.toFixed(1)}) = ${finalScore.toFixed(2)}</p>
                </div>
            `;
            
            qaHistoryContainer.appendChild(finalScoreItem);
        }
        
        // Add individual QA reviews
        project.qaHistory.forEach(qa => {
            const qaItem = document.createElement('div');
            qaItem.className = 'bg-white p-4 rounded-lg shadow-sm';
            
            const qaTypeBadge = qa.qaType === 'first-draft' ? 
                '<span class="qa-type-badge qa-type-first-draft">First Draft QA</span>' : 
                '<span class="qa-type-badge qa-type-revision">Revision QA</span>';
            
            qaItem.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div>
                        ${qaTypeBadge}
                        <span class="font-medium text-gray-700">Reviewed on: ${formatDate(qa.date)}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Score: </span>
                        <span class="font-medium ${qa.score >= 3.6 ? 'text-green-600' : 'text-red-600'}">${qa.score.toFixed(1)}</span>
                        <span class="ml-2 px-2 py-1 rounded-full text-xs ${qa.status === 'pass' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${qa.status === 'pass' ? 'Pass' : 'Fail'}
                        </span>
                    </div>
                </div>
                <p class="text-gray-700 mb-2">${qa.comments}</p>
                ${qa.findings.length > 0 ? `
                    <div class="mt-2">
                        <h5 class="font-medium text-gray-700 mb-1">Findings:</h5>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Lesson</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Category</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Error Type</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Description</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Resolved</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${qa.findings.map(f => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="py-2 px-3 text-sm">${f.lesson || '-'}</td>
                                            <td class="py-2 px-3 text-sm">${getCategoryWithIcon(f.category)}</td>
                                            <td class="py-2 px-3 text-sm">${f.type}</td>
                                            <td class="py-2 px-3 text-sm description-tooltip">
                                                <span class="text-blue-600 underline cursor-pointer">View</span>
                                                <span class="tooltip-text">${f.description}</span>
                                            </td>
                                            <td class="py-2 px-3 text-sm">
                                                ${f.resolved ? 
                                                    '<span class="text-green-600">✓</span>' : 
                                                    '<span class="text-red-600">✗</span>'
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : '<p class="text-gray-500 italic">No findings recorded.</p>'}
            `;
            
            qaHistoryContainer.appendChild(qaItem);
        });
    }
    
    projectDetailsModal.style.display = 'block';
}

// Get category with icon
function getCategoryWithIcon(category) {
    let icon = '';
    switch(category) {
        case 'Content':
            icon = '📝';
            break;
        case 'Design':
            icon = '🎨';
            break;
        case 'Function':
            icon = '⚙️';
            break;
        case 'Improvement':
            icon = '🛠️';
            break;
    }
    return `<span class="category-icon">${icon}</span> ${category}`;
}

closeProjectDetails.addEventListener('click', () => {
    projectDetailsModal.style.display = 'none';
});

closeDetails.addEventListener('click', () => {
    projectDetailsModal.style.display = 'none';
});

// Populate QA project select
function populateQaProjectSelect() {
    qaProjectSelect.innerHTML = '<option value="">Select a project</option>';
    
    const inProgressProjects = projects.filter(p => p.status === 'in-progress' || p.status === 'needs-revision');
    
    if (inProgressProjects.length === 0) {
        const option = document.createElement('option');
        option.disabled = true;
        option.textContent = 'No projects available for QA';
        qaProjectSelect.appendChild(option);
    } else {
        inProgressProjects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = `${project.name} (${project.language})`;
            qaProjectSelect.appendChild(option);
        });
    }
}

// QA project select change
qaProjectSelect.addEventListener('change', () => {
    const projectId = qaProjectSelect.value;
    if (!projectId) {
        document.getElementById('qa-project-name').textContent = '-';
        document.getElementById('qa-project-language').textContent = '-';
        document.getElementById('qa-project-owner').textContent = '-';
        document.getElementById('qa-project-due-date').textContent = '-';
        return;
    }
    
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    document.getElementById('qa-project-name').textContent = project.name;
    document.getElementById('qa-project-language').textContent = project.language;
    document.getElementById('qa-project-owner').textContent = project.owner;
    document.getElementById('qa-project-due-date').textContent = formatDate(project.dueDate);
    
    // Reset findings
    findingsTableBody.innerHTML = '';
    currentScore.textContent = '4.0';
    scoreProgress.style.width = '100%';
    scoreProgress.style.backgroundColor = '#3B82F6';
    qaStatus.textContent = 'Pass';
    qaStatus.className = 'px-2 py-1 rounded-full text-xs bg-green-100 text-green-800';
    findingsCount.textContent = '0';
    document.getElementById('qa-comments').value = '';
    
    // Set QA mode based on project history
    const hasFirstDraft = project.qaHistory.some(qa => qa.qaType === 'first-draft');
    if (hasFirstDraft && !project.qaHistory.some(qa => qa.qaType === 'revision')) {
        qaMode.value = 'revision';
        qaMode.dispatchEvent(new Event('change'));
    } else {
        qaMode.value = 'first-draft';
        qaMode.dispatchEvent(new Event('change'));
    }
});

// Populate error types based on category
findingCategory.addEventListener('change', () => {
    const category = findingCategory.value;
    findingType.innerHTML = '<option value="">Select Error Type</option>';
    
    if (category && errorTypes[category]) {
        errorTypes[category].forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            findingType.appendChild(option);
        });
    }
});

// Add finding
addFinding.addEventListener('click', () => {
    const lesson = document.getElementById('finding-lesson').value;
    const category = findingCategory.value;
    const type = findingType.value;
    const description = document.getElementById('finding-description').value;
    
    if (!category || !type || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    addFindingToTable(lesson, category, type, description);
    
    // Clear inputs
    document.getElementById('finding-lesson').value = '';
    findingCategory.value = '';
    findingType.innerHTML = '<option value="">Select Error Type</option>';
    document.getElementById('finding-description').value = '';
});

// Add finding to table
function addFindingToTable(lesson, category, type, description) {
    // Get category icon
    let categoryIcon = '';
    switch(category) {
        case 'Content':
            categoryIcon = '📝';
            break;
        case 'Design':
            categoryIcon = '🎨';
            break;
        case 'Function':
            categoryIcon = '⚙️';
            break;
        case 'Improvement':
            categoryIcon = '🛠️';
            break;
    }
    
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';
    row.innerHTML = `
        <td class="py-3 px-4 border-b">${lesson || '-'}</td>
        <td class="py-3 px-4 border-b"><span class="category-icon">${categoryIcon}</span> ${category}</td>
        <td class="py-3 px-4 border-b">${type}</td>
        <td class="py-3 px-4 border-b description-tooltip">
            <span class="text-blue-600 underline cursor-pointer">View</span>
            <span class="tooltip-text">${description}</span>
        </td>
        <td class="py-3 px-4 border-b">
            <label class="toggle-switch">
                <input type="checkbox" class="resolved-toggle">
                <span class="toggle-slider"></span>
            </label>
        </td>
        <td class="py-3 px-4 border-b">
            <button class="remove-finding text-red-600 hover:text-red-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </td>
    `;
    
    findingsTableBody.appendChild(row);
    
    // Update score
    updateScore();
    
    // Add event listener to remove button
    row.querySelector('.remove-finding').addEventListener('click', () => {
        row.remove();
        updateScore();
    });
    
    // Add event listener to resolved toggle
    row.querySelector('.resolved-toggle').addEventListener('change', () => {
        updateScore();
    });
}

// Update score based on findings
function updateScore() {
    const findings = document.querySelectorAll('#findings-table-body tr');
    const errorCount = findings.length;
    const mode = qaMode.value;
    
    let score = 4.0;
    
    // Calculate score based on error count and QA mode
    if (mode === 'first-draft') {
        if (errorCount === 1) score = 3.9;
        else if (errorCount >= 2 && errorCount <= 3) score = 3.8;
        else if (errorCount === 4) score = 3.7;
        else if (errorCount === 5) score = 3.6;
        else if (errorCount >= 6) score = 3.0;
    } else { // revision mode
        if (errorCount === 1) score = 3.8;
        else if (errorCount === 2) score = 3.7;
        else if (errorCount === 3) score = 3.6;
        else if (errorCount >= 4) score = 3.0;
    }
    
    currentScore.textContent = score.toFixed(1);
    
    // Update progress bar
    const percentage = (score / 4) * 100;
    scoreProgress.style.width = `${percentage}%`;
    
    // Update color based on score
    if (score >= 3.6) {
        scoreProgress.style.backgroundColor = '#10B981';
        qaStatus.textContent = 'Pass';
        qaStatus.className = 'px-2 py-1 rounded-full text-xs bg-green-100 text-green-800';
    } else {
        scoreProgress.style.backgroundColor = '#EF4444';
        qaStatus.textContent = 'Fail';
        qaStatus.className = 'px-2 py-1 rounded-full text-xs bg-red-100 text-red-800';
    }
    
    // Update findings count
    findingsCount.textContent = errorCount;
}

// QA mode change
qaMode.addEventListener('change', () => {
    updateScore();
});

// Project search
projectSearch.addEventListener('input', () => {
    currentFilters.search = projectSearch.value.trim();
    updateProjectsTable();
});

// Project filter
projectFilter.addEventListener('change', () => {
    currentFilters.status = projectFilter.value;
    updateProjectsTable();
});

// Apply date filter
applyDateFilter.addEventListener('click', () => {
    const monthValue = monthFilter.value;
    const yearValue = yearFilter.value;
    
    currentFilters.month = monthValue === '' ? null : parseInt(monthValue);
    currentFilters.year = yearValue === '' ? null : parseInt(yearValue);
    
    updateActiveFilters();
    updateProjectsTable();
});

// Show toast notification
function showToast(message) {
    toastMessage.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// CSV Import Functions
function openCsvImportModal() {
    csvImportModal.style.display = 'block';
    csvUploadStatus.innerHTML = '';
    importCsvBtn.disabled = true;
    csvData = null;
}

closeCsvImport.addEventListener('click', () => {
    csvImportModal.style.display = 'none';
});

cancelCsvImport.addEventListener('click', () => {
    csvImportModal.style.display = 'none';
});

function setupCSVUpload() {
    // File input change
    csvFileInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop
    csvUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        csvUploadArea.classList.add('drag-over');
    });
    
    csvUploadArea.addEventListener('dragleave', () => {
        csvUploadArea.classList.remove('drag-over');
    });
    
    csvUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        csvUploadArea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            csvFileInput.files = files;
            handleFileSelect(e);
        }
    });
    
    // Download template
    downloadTemplateBtn.addEventListener('click', (e) => {
        e.preventDefault();
        downloadCsvTemplate();
    });
    
    // Import CSV button
    importCsvBtn.addEventListener('click', importCsvData);
}

function handleFileSelect(e) {
    const file = csvFileInput.files[0];
    if (!file) return;
    
    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        csvUploadStatus.innerHTML = '<p class="csv-error">Please select a CSV file</p>';
        importCsvBtn.disabled = true;
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const content = e.target.result;
            csvData = parseCSV(content);
            
            if (csvData.length === 0) {
                csvUploadStatus.innerHTML = '<p class="csv-error">CSV file is empty</p>';
                importCsvBtn.disabled = true;
                return;
            }
            
            // Validate CSV structure
            const requiredColumns = ['Lesson', 'Category', 'Error Type', 'Description'];
            const headers = Object.keys(csvData[0]);
            
            const missingColumns = requiredColumns.filter(col => !headers.includes(col));
            
            if (missingColumns.length > 0) {
                csvUploadStatus.innerHTML = `<p class="csv-error">Missing required columns: ${missingColumns.join(', ')}</p>`;
                importCsvBtn.disabled = true;
                return;
            }
            
            csvUploadStatus.innerHTML = `<p class="csv-success">File loaded successfully. Found ${csvData.length} findings.</p>`;
            importCsvBtn.disabled = false;
        } catch (error) {
            csvUploadStatus.innerHTML = `<p class="csv-error">Error parsing CSV: ${error.message}</p>`;
            importCsvBtn.disabled = true;
        }
    };
    
    reader.readAsText(file);
}

function parseCSV(text) {
    const lines = text.split('\n');
    const result = [];
    const headers = lines[0].split(',').map(h => h.trim());
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim() === '') continue;
        
        const obj = {};
        const currentLine = lines[i].split(',');
        
        for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = currentLine[j] ? currentLine[j].trim() : '';
        }
        
        result.push(obj);
    }
    
    return result;
}

function downloadCsvTemplate() {
    const template = 'Lesson,Category,Error Type,Description\nLesson 1,Content,Text-based content are not translated,Description here\nLesson 2,Design,Visual assets are overlapping,Description here';
    
    const blob = new Blob([template], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'findings_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importCsvData() {
    if (!csvData) return;
    
    // Clear existing findings
    findingsTableBody.innerHTML = '';
    
    // Add findings from CSV
    csvData.forEach(row => {
        const lesson = row['Lesson'];
        const category = row['Category'];
        const type = row['Error Type'];
        const description = row['Description'];
        
        if (category && type && description) {
            addFindingToTable(lesson, category, type, description);
        }
    });
    
    csvImportModal.style.display = 'none';
    showToast(`Imported ${csvData.length} findings successfully!`);
}
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96377bd6643e8d03',t:'MTc1MzIzNDk3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>